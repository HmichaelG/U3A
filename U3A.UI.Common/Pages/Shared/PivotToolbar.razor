@using DevExpress.Blazor.Reporting.Models
@using DevExpress.Drawing
@using DevExpress.Drawing.Printing
@using Microsoft.JSInterop
@using DevExpress.Export
@using System.Drawing
@using System.Collections
@using System.Text.Json
@using DevExpress.Blazor
@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Components.Routing
@using System.Text.RegularExpressions
@using Serilog
@using U3A.UI.Reports.Pages

@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject NavigationManager navMan
@inject IToastNotificationService ToastService
@inject IJSRuntime js

<DxToastProvider Name="Result" AnimationType="ToastAnimationType.Slide" ShowIcon="true" />

<DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Contained" CssClass="mb-1 w-100"
           ItemClick="OnItemClick">
    <Items>
        @CustomButtonContentAtStart
        <DxToolbarItem IconCssClass="bi bi-list" Text="Rows"
                       BeginGroup=true
                       Alignment="ToolbarItemAlignment.Right"
                       Tooltip="Customise row layout">
            <Items>
                <DxToolbarItem Text="@((isRowsCollapsed) ? "Expand All" : "Collapse All")"
                               Click="CollapseExpandRows"
                               Tooltip="Collapse/Expand all rows in the Pivot Table">
                </DxToolbarItem>
                <DxToolbarItem Text="@((isRowTotalsHidden) ? "Show Totals" : "Hide Totals")"
                               Click="ShowHideRowTotals" BeginGroup=true
                               Tooltip="Hide/Show row totals">
                </DxToolbarItem>
                <DxToolbarItem Text="@((isRowGrandTotalsHidden) ? "Show Grand Totals" : "Hide Grand Totals")"
                               Click="ShowHideRowGrandTotals"
                               Tooltip="Hide/Show row grand totals">
                </DxToolbarItem>
            </Items>
        </DxToolbarItem>
        <DxToolbarItem IconCssClass="bi bi-list-columns" Text="Columns"
                       BeginGroup=true
                       Alignment="ToolbarItemAlignment.Right"
                       Tooltip="Customise column layout">
            <Items>
                <DxToolbarItem Text="@((isColumnsCollapsed) ? "Expand All" : "Collapse All")"
                               Click="CollapseExpandColumns"
                               Tooltip="Collapse/Expand all columns in the Pivot Table">
                </DxToolbarItem>
                <DxToolbarItem Text="@((isColumnTotalsHidden) ? "Show Totals" : "Hide Totals")"
                               Click="ShowHideColumnTotals" BeginGroup=true
                               Tooltip="Hide/Show row grand totals">
                </DxToolbarItem>
                <DxToolbarItem Text="@((isColumnGrandTotalsHidden) ? "Show Grand Totals" : "Hide Grand Totals")"
                               Click="ShowHideColumnGrandTotals"
                               Tooltip="Hide/Show row grand totals">
                </DxToolbarItem>
            </Items>
        </DxToolbarItem>
        <DxToolbarItem IconCssClass="bi bi-list-columns-reverse" Name="Layout" Text="Layout"
                       BeginGroup=true
                       Alignment="ToolbarItemAlignment.Right"
                       CssClass="column-chooser-button"
                       Tooltip="Customise column layout">
            <Items>
                <DxToolbarItem Text="Show Field List" Name="FieldList"
                               Tooltip="Customise the Pivot Table">
                </DxToolbarItem>
                <DxToolbarItem IconCssClass="bi bi-floppy"
                               Name="SaveLayout" Text="Save Layout"
                               Tooltip="Save the current layout">
                </DxToolbarItem>
                <DxToolbarItem IconCssClass="bi bi-arrow-counterclockwise"
                               Name="ResetLayout" Text="Reset Default Layout"
                               Tooltip="Reset column layout to its default">
                </DxToolbarItem>
            </Items>
        </DxToolbarItem>
        <DxToolbarItem IconCssClass="bi bi-funnel" Name="ClearFilter" Text="Clear Filters"
                       BeginGroup=true
                       Alignment="ToolbarItemAlignment.Right"
                       Tooltip="Clear all filters">
        </DxToolbarItem>
        <DxToolbarItem IconCssClass="bi bi-database" Name="DataLoad" Text="Load Data"
                       BeginGroup=true
                       RenderStyle="ButtonRenderStyle.Primary"
                       Alignment="ToolbarItemAlignment.Right"
                       Tooltip="Load the pivot table's data'">
        </DxToolbarItem>
        @CustomButtonContent
    </Items>
</DxToolbar>


@code {

    [Parameter, EditorRequired]
    public IPivotTable? LinkedGrid { get; set; }
    [Parameter] public string? LayoutKey { get; set; }
    [Parameter] public RenderFragment? CustomButtonContentAtStart { get; set; }
    [Parameter] public RenderFragment? CustomButtonContent { get; set; }
    [Parameter] public EventCallback DataLoadRequested { get; set; }

    PivotTablePersistentLayout? defaultLayout;
    PivotTablePersistentLayout? layout;
    bool isRowsCollapsed;
    bool isColumnsCollapsed;
    bool isRowGrandTotalsHidden;
    bool isColumnGrandTotalsHidden;
    bool isRowTotalsHidden;
    bool isColumnTotalsHidden;

    async Task OnItemClick(ToolbarItemClickEventArgs e)
    {
        if (LinkedGrid == null) { return; }
        LinkedGrid.BeginUpdate();
        if (defaultLayout == null) { defaultLayout = LinkedGrid.SaveLayout(); }
        switch (e.ItemName)
        {
            case "FieldList":
                LinkedGrid!.ShowFieldList();
                break;
            case "SaveLayout":
                await localStorage.SetItemAsync(LayoutKey!, LinkedGrid.SaveLayout());
                ToastService.ShowToast(new ToastOptions()
                {
                    Title = "Layout Saved",
                    Text = "Your pivot table's layout has been saved.",
                    ProviderName = "Result",
                    ThemeMode = ToastThemeMode.Pastel,
                    RenderStyle = ToastRenderStyle.Success,
                    IconCssClass = "bi bi-check-circle"
                });
                break;
            case "ResetLayout":
                await localStorage.RemoveItemAsync(LayoutKey!);
                LinkedGrid.LoadLayout(defaultLayout);
                ToastService.ShowToast(new ToastOptions()
                {
                    Title = "Reset Layout",
                    Text = "The default layout is restored.",
                    ProviderName = "Result",
                    ThemeMode = ToastThemeMode.Pastel,
                    RenderStyle = ToastRenderStyle.Success,
                    IconCssClass = "bi bi-check-circle"
                });
                break;
            case "ClearFilter":
                LinkedGrid.ClearFilter();
                ToastService.ShowToast(new ToastOptions()
                {
                    Title = "Filters Cleared",
                    Text = "All pivot table filters have been cleared.",
                    ProviderName = "Result",
                    ThemeMode = ToastThemeMode.Pastel,
                    RenderStyle = ToastRenderStyle.Success,
                    IconCssClass = "bi bi-check-circle"
                });
                break;
            case "DataLoad":
                await LoadLayoutAsync();
                await DataLoadRequested.InvokeAsync();
                isRowsCollapsed = false;
                isColumnsCollapsed = false;
                break;
        }
        LinkedGrid.EndUpdate();
    }

    void CollapseExpandRows()
    {
        isRowsCollapsed = !isRowsCollapsed;
        if (isRowsCollapsed)
        {
            LinkedGrid!.CollapseAllRows();
        }
        else
        {
            LinkedGrid!.ExpandAllRows();
        }
    }
    void CollapseExpandColumns()
    {
        isColumnsCollapsed = !isColumnsCollapsed;
        if (isColumnsCollapsed)
        {
            LinkedGrid!.CollapseAllColumns();
        }
        else
        {
            LinkedGrid!.ExpandAllColumns();
        }
    }
    void ShowHideRowTotals()
    {
        isRowTotalsHidden = !isRowTotalsHidden;
        LinkedGrid!.BeginUpdate();
        LinkedGrid!.ShowRowTotals = !isRowTotalsHidden;
        LinkedGrid!.EndUpdate();
    }
    void ShowHideColumnTotals()
    {
        isColumnTotalsHidden = !isColumnTotalsHidden;
        LinkedGrid!.BeginUpdate();
        LinkedGrid!.ShowColumnTotals = !isColumnTotalsHidden;
        LinkedGrid!.EndUpdate();
    }
    void ShowHideRowGrandTotals()
    {
        isRowGrandTotalsHidden = !isRowGrandTotalsHidden;
        LinkedGrid!.BeginUpdate();
        LinkedGrid!.ShowRowGrandTotals = !isRowGrandTotalsHidden;
        LinkedGrid!.EndUpdate();
    }
    void ShowHideColumnGrandTotals()
    {
        isColumnGrandTotalsHidden = !isColumnGrandTotalsHidden;
        LinkedGrid!.BeginUpdate();
        LinkedGrid!.ShowColumnGrandTotals = !isColumnGrandTotalsHidden;
        LinkedGrid!.EndUpdate();
    }

    async Task LoadLayoutAsync()
    {
        if (LinkedGrid is DxPivotTable dxPivot)
        {
            if (LayoutKey != null)
            {
                defaultLayout = dxPivot.SaveLayout();
                layout = await localStorage.GetItemAsync<PivotTablePersistentLayout>(LayoutKey);
                if (layout != null)
                {
                    dxPivot.LoadLayout(layout);
                    ToastService.ShowToast(new ToastOptions()
                    {
                        Title = "Layout Restored",
                        Text = "Grid restored from saved layout.",
                        ProviderName = "Result",
                        ThemeMode = ToastThemeMode.Pastel,
                        RenderStyle = ToastRenderStyle.Success,
                        IconCssClass = "bi bi-check-circle"
                    });
                }
            }
        }
    }

}
