@inject IJSRuntime JS

<div class="expandable-text-wrapper">
    <div class="expandable-text-container @(isExpanded ? "expanded" : "")"
         style="--max-height:@MaxHeight"
         @ref="containerRef">
        <div class="text-content">
            @ChildContent
        </div>
        @if (showToggle)
        {
            <div class="fade-overlay"></div>
        }
    </div>

    @if (showToggle)
    {
        <DxButton CssClass="toggle-button"
                  RenderStyleMode="ButtonRenderStyleMode.Outline"
                  Click="ToggleExpanded"
                  Text=@(isExpanded ? "Show Less" : "Show More") />
    }
</div>

@code {
    private bool isExpanded = false;
    private bool showToggle = true;
    private ElementReference containerRef;
    private RenderFragment? savedContent;

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public string MaxHeight { get; set; } = "7rem";

    SemaphoreSlim semaphore = new SemaphoreSlim(initialCount: 0);
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await semaphore.WaitAsync(); // Asynchronously wait for access
        try
        {
            if (savedContent != ChildContent)
            {
                savedContent = ChildContent;
                isExpanded = false; // Reset to collapsed state when content changes
                await Task.Delay(100); // Let layout settle
                showToggle = await JS.InvokeAsync<bool>("checkOverflow", containerRef, MaxHeight);
                StateHasChanged();
            }
        }
        finally
        {
            semaphore.Release(); // Always release, even on exception
        }
    }

    private void ToggleExpanded()
    {
        isExpanded = !isExpanded;
    }
}