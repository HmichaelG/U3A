@using System.Collections.Concurrent
@inject IJSRuntime JS

<div class="expandable-text-wrapper">
    <div class="expandable-text-container @(isExpanded ? "expanded" : "")"
         style="--max-height:@MaxHeight"
         @ref="containerRef">
        <div class="text-content">
            @ChildContent
        </div>
        @if (showToggle)
        {
            <div class="fade-overlay"></div>
        }
    </div>

    @if (showToggle)
    {
        <DxButton CssClass="toggle-button"
        RenderStyleMode="ButtonRenderStyleMode.Outline"
        Click="ToggleExpanded"
        Text=@(isExpanded ? "Show Less" : "Show More") />
    }
</div>

@code {
    private bool isExpanded = false;
    private bool showToggle = true;
    private ElementReference containerRef;
    private RenderFragment? savedContent;

    [Parameter, EditorRequired]
    public Guid Key { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public string MaxHeight { get; set; } = "7rem";

    private ConcurrentDictionary<Guid,bool?> bag = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!bag.TryGetValue(Key, out var showToggleState))
        {
            await Task.Delay(100); // Let layout settle
            showToggle = await JS.InvokeAsync<bool>("checkOverflow", containerRef, MaxHeight);
            isExpanded = false;
            bag[Key] = showToggle;
        }
        else
        {
            if (showToggleState.HasValue) showToggle = showToggleState.Value;
        }
        StateHasChanged();
    }

    private void ToggleExpanded()
    {
        isExpanded = !isExpanded;
    }
}